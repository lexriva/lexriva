<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lexriva | Collections</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --cherry: #72001A; --gold: #D4AF37; --lavender: #F9F7FF; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--lavender); padding-bottom: 80px; }
        
        .header { background: #fff; padding: 15px 20px; display: flex; align-items: center; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid #eee; }
        .back-btn { font-size: 24px; color: var(--cherry); cursor: pointer; text-decoration: none; font-weight: 900; margin-right: 15px; }
        .page-title { font-family: 'Cinzel'; font-size: 14px; font-weight: 900; color: var(--cherry); flex-grow: 1; text-align: center; letter-spacing: 2px; }

        .p-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; }
        .p-card { background: #fff; border-radius: 20px; padding: 10px; text-align: center; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.05); cursor: pointer; }
        .p-card img { width: 100%; height: 210px; object-fit: cover; border-radius: 15px; }
        .p-card h3 { font-size: 11px; margin: 10px 0 5px; color: #333; height: 30px; overflow: hidden; font-weight: 600; text-transform: uppercase; }
        .price-box { display: flex; justify-content: center; align-items: center; gap: 8px; }
        .price { font-weight: 900; color: var(--cherry); font-size: 15px; }
        .old-p { font-size: 11px; color: #999; text-decoration: line-through; }
        
        .wish-heart { position: absolute; top: 18px; right: 18px; background: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); color: #ddd; font-size: 16px; transition: 0.3s; }
        .wish-heart.active { color: red; }

        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #eee; z-index: 1000; }
        .nav-btn { font-size: 10px; font-weight: 800; color: #bbb; text-align: center; text-decoration: none; }
    </style>
</head>
<body>

    <div class="header">
        <div class="back-btn" onclick="history.back()">‚Üê</div>
        <div class="page-title" id="listTitle">COLLECTION</div>
    </div>

    <div id="productGrid" class="p-grid">
        </div>

    <div class="bottom-nav">
        <a href="index.html" class="nav-btn">üè†<br>HOME</a>
        <a href="category.html" class="nav-btn">üëó<br>CATEGORY</a>
        <a href="wishlist.html" class="nav-btn">üíñ<br>WISHLIST</a>
        <a href="login.html" class="nav-btn">üë§<br>LOGIN</a>
    </div>

    <script>
        const API = "https://script.google.com/macros/s/AKfycbwdDAiEuLykJJPxRK7Gh89yF-Pmyf71RKMGTh83j-SYe4AGKuqMR1zY9UcrKQbnoFU/exec";
        
        async function fetchProducts() {
            const sub = localStorage.getItem('activeSubCat') || 'Collection';
            document.getElementById('listTitle').innerText = sub.toUpperCase();

            try {
                const res = await fetch(API);
                const data = await res.json();
                let all = [];

                // Searching across all tabs (eid, latest, western, etc.)
                Object.keys(data).forEach(key => {
                    if(Array.isArray(data[key])) {
                        let filtered = data[key].filter(p => 
                            (p.subCat && p.subCat.trim().toLowerCase() === sub.toLowerCase()) ||
                            (p.n && p.n.toLowerCase().includes(sub.toLowerCase())) ||
                            (sub === 'under499' && parseInt(p.p) <= 499) ||
                            (sub === 'under999' && parseInt(p.p) <= 999)
                        );
                        all = [...all, ...filtered];
                    }
                });

                renderGrid(all);
            } catch (e) { console.log("Data Load Error"); }
        }

        function renderGrid(list) {
            let wish = JSON.parse(localStorage.getItem('lexWish')) || [];
            const grid = document.getElementById('productGrid');
            
            if(list.length === 0) {
                grid.innerHTML = "<p style='grid-column: span 2; text-align:center; padding:50px; color:#888;'>Coming Soon...</p>";
                return;
            }

            grid.innerHTML = list.map((p, i) => {
                const isWished = wish.some(x => x.n === p.n) ? 'active' : '';
                return `
                <div class="p-card" onclick="openDetail('${p.sheetName || 'latest'}', ${i})">
                    <div class="wish-heart ${isWished}" onclick="event.stopPropagation(); toggleWish(this, '${p.n}', '${p.p}', '${p.i}')">‚ô•</div>
                    <img src="${p.i}">
                    <h3>${p.n}</h3>
                    <div class="price-box">
                        <span class="price">‚Çπ${p.p}</span>
                        <span class="old-p">‚Çπ${Math.round(p.p * 1.5)}</span>
                    </div>
                </div>`;
            }).join('');
        }

        function toggleWish(btn, n, p, i) {
            let wish = JSON.parse(localStorage.getItem('lexWish')) || [];
            const idx = wish.findIndex(x => x.n === n);
            if(idx > -1) { wish.splice(idx, 1); btn.classList.remove('active'); }
            else { wish.push({n, p, i}); btn.classList.add('active'); }
            localStorage.setItem('lexWish', JSON.stringify(wish));
        }

        function openDetail(sheet, idx) {
            localStorage.setItem('targetSheet', sheet);
            localStorage.setItem('targetIdx', idx);
            window.location.href = "product.html";
        }

        window.onload = fetchProducts;
    </script>
</body>
</html>
